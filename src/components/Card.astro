---
/**
 * Card Component
 *
 * Reusable card component for displaying projects and publications.
 * Dynamically generates action buttons based on available link properties in the data.
 *
 * Supported link types: github, download, web, use, youtube, pdf, online, dataset
 */
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import {
    Database,
    Download,
    GitBranch,
    Github,
    Globe,
    LibraryBig,
    Link as LinkIcon,
    Youtube,
} from 'lucide-astro';
import { ICON_SIZES } from '../constants/ui';
import type { Project, Publication } from '../types';
import { extractCardLinks } from '../utils/cardLinks';
import { slugify } from '../utils/slugify';

interface Props {
    item: Project | Publication;
    type: 'project' | 'publication';
}

const { item, type } = Astro.props;

// Generate unique ID for this card
const cardId = `${type}-${slugify(item.title)}`;

// Import all images from assets directory at build time
const images = import.meta.glob<{ default: ImageMetadata }>('../assets/*.{webp,gif,png,jpg,jpeg}', {
    eager: true,
});

// Get the correct image for this item
const imagePath = `../assets/${item.image}`;
const imageModule = images[imagePath];
const imageSrc = imageModule?.default;

// Throw error if image not found
if (!imageSrc) {
    throw new Error(`Image not found: ${item.image}`);
}

// Icon mapping for button components
const ICON_MAP = {
    github: Github,
    download: Download,
    web: Globe,
    use: GitBranch,
    youtube: Youtube,
    pdf: LibraryBig,
    online: LinkIcon,
    dataset: Database,
} as const;

// Button configuration for different link types
const BUTTON_STYLES = {
    github: 'bg-button-github hover:bg-button-github-hover text-white',
    download: 'bg-button-download hover:bg-button-download-hover text-white',
    web: 'bg-button-web hover:bg-button-web-hover text-white',
    use: 'bg-button-use hover:bg-button-use-hover text-white',
    youtube: 'bg-button-youtube hover:bg-button-youtube-hover text-white',
    pdf: 'bg-button-pdf hover:bg-button-pdf-hover text-white',
    online: 'bg-button-online hover:bg-button-online-hover text-white',
    dataset: 'bg-button-dataset hover:bg-button-dataset-hover text-white',
} as const;

const BUTTON_LABELS = {
    github: 'GitHub',
    download: 'Download',
    web: 'Visit',
    use: 'Use This',
    youtube: 'YouTube',
    pdf: 'PDF',
    online: 'Online',
    dataset: 'Dataset',
} as const;

// Extract links from item data
const links = extractCardLinks(item);
---

<div id={cardId} class="card group bg-card-light dark:bg-card-dark border border-card-border-light dark:border-card-border-dark rounded-card p-0 scroll-mt-24">
    <!-- Image -->
    <div class="relative overflow-hidden aspect-video rounded-card-image">
        <Image
            src={imageSrc}
            alt={item.title}
            class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"
            widths={[200, 400, 800]}
            sizes="(max-width: 800px) 100vw, 800px"
        />
    </div>

    <!-- Content -->
    <div class="space-y-4 p-8">
        <!-- Title -->
        <h3 class="text-gray-900 dark:text-white flex items-center gap-2">
            {item.title}
            <button
                class="copy-link-btn opacity-0 group-hover:opacity-100 transition-opacity text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                data-card-id={cardId}
                data-section={type === 'project' ? 'projects' : 'publications'}
                aria-label="Copy link to this card"
                title="Copy link"
            >
                <LinkIcon size={ICON_SIZES.SM} />
            </button>
        </h3>

        <!-- Description or Publisher -->
        <p class="text-gray-700 dark:text-gray-300">
            {type === 'publication' && 'publisher' in item ? item.publisher : 'description' in item ? item.description : ''}
        </p>

        <!-- Action Buttons -->
        {
            links.length > 0 && (
                <div class="flex flex-wrap gap-3 pt-2">
                    {links.map(({ type: linkType, url }) => {
                        const Icon = ICON_MAP[linkType as keyof typeof ICON_MAP];
                        const label = BUTTON_LABELS[linkType as keyof typeof BUTTON_LABELS];
                        const styleClass = BUTTON_STYLES[linkType as keyof typeof BUTTON_STYLES];

                        if (!Icon || !label || !styleClass) return null;

                        return (
                            <a
                                href={url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class={`inline-flex items-center gap-2 font-medium transition-all duration-200 text-sm rounded-button py-2 px-7 ${styleClass}`}
                            >
                                <Icon size={ICON_SIZES.SM} />
                                {label}
                            </a>
                        );
                    })}
                </div>
            )
        }
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Handle copy link buttons
        document.querySelectorAll('.copy-link-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const button = e.currentTarget as HTMLButtonElement;
                const cardId = button.dataset.cardId;
                const section = button.dataset.section;
                
                if (cardId && section) {
                    const url = `${window.location.origin}${window.location.pathname}#${section}/${cardId}`;
                    
                    try {
                        await navigator.clipboard.writeText(url);
                        
                        // Show feedback
                        const originalTitle = button.title;
                        button.title = 'Copied!';
                        button.style.color = 'rgb(34, 197, 94)';
                        
                        setTimeout(() => {
                            button.title = originalTitle;
                            button.style.color = '';
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy link:', err);
                    }
                }
            });
        });
    });

    // Re-run on Astro page transitions
    document.addEventListener('astro:page-load', () => {
        document.querySelectorAll('.copy-link-btn').forEach(btn => {
            const clonedBtn = btn.cloneNode(true);
            btn.parentNode?.replaceChild(clonedBtn, btn);
        });
    });
</script>
